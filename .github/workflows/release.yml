# SPDX-License-Identifier: MPL-2.0
name: Release

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: Mark as pre-release
        type: boolean
        default: true
permissions:
  contents: write
jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      tag: ${{ steps.extract.outputs.tag }}
    steps:
      - uses: actions/checkout@v5
      - name: Extract version
        id: extract
        run: |
          version=$(sed -n 's/^[[:space:]]*VERSION[[:space:]]\+\([0-9.]\+\).*/\1/p' CMakeLists.txt | head -1)
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=v${version}-$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Build docs
        run: |
          curl -sSL https://github.com/rust-lang/mdBook/releases/download/v0.4.40/mdbook-v0.4.40-x86_64-unknown-linux-gnu.tar.gz | tar xz
          ./mdbook build docs
      - uses: actions/upload-artifact@v4
        with:
          name: docs
          path: docs/book

  windows-x64:
    needs: version
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v5
      - name: Fetch ZDSR
        shell: pwsh
        run: |
          choco install innoextract -y
          curl -L -o zdsr.exe "https://www.zd.hk/download-down-type-zdsr.htm"
          innoextract -e --codepage 65001 -d zdsr-extract zdsr.exe
          Get-ChildItem -Recurse -Filter "ZDSRAPI_x64.dll" | Select-Object -First 1 | Copy-Item -Destination .
      - name: Build Release
        run: |
          cmake -B build-release -G Ninja -DCMAKE_BUILD_TYPE=Release -DPRISM_ENABLE_TESTS=OFF
          cmake --build build-release
      - name: Build Debug
        run: |
          cmake -B build-debug -G Ninja -DCMAKE_BUILD_TYPE=Debug -DPRISM_ENABLE_TESTS=OFF
          cmake --build build-debug
      - name: Package
        shell: pwsh
        run: |
          mkdir -p dist/release/{lib,bin}
          mkdir -p dist/debug/{lib,bin}
          mkdir -p dist/include
          cp build-release/prism.dll dist/release/bin/
          cp build-release/prism.lib dist/release/lib/
          cp build-release/nvdaControllerClient.dll dist/release/bin/
          cp ZDSRAPI_x64.dll dist/release/bin/
          cp include/prism.h dist/include/
          cp build-debug/prism.dll dist/debug/bin/
          cp build-debug/prism.lib dist/debug/lib/
          cp build-debug/prism.pdb dist/debug/bin/
          cp build-debug/nvdaControllerClient.dll dist/debug/bin/
          cp ZDSRAPI_x64.dll dist/debug/bin/
          Compress-Archive -Path dist/* -DestinationPath prism-windows-x64.zip
      - uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: prism-windows-x64.zip
  windows-arm64:
    needs: version
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v5
      - name: Build Release
        run: |
          cmake -B build-release -G Ninja -DCMAKE_BUILD_TYPE=Release -DPRISM_ENABLE_TESTS=OFF -DCMAKE_SYSTEM_PROCESSOR=ARM64
          cmake --build build-release
      - name: Build Debug
        run: |
          cmake -B build-debug -G Ninja -DCMAKE_BUILD_TYPE=Debug -DPRISM_ENABLE_TESTS=OFF -DCMAKE_SYSTEM_PROCESSOR=ARM64
          cmake --build build-debug
      - name: Package
        shell: pwsh
        run: |
          mkdir -p dist/release/{lib,bin,include}
          mkdir -p dist/debug/{lib,bin}
          mkdir -p dist/include
          cp build-release/prism.dll dist/release/bin/
          cp build-release/prism.lib dist/release/lib/
          cp build-release/nvdaControllerClient.dll dist/release/bin/
          cp include/prism.h dist/include/
          cp build-debug/prism.dll dist/debug/bin/
          cp build-debug/prism.lib dist/debug/lib/
          cp build-debug/prism.pdb dist/debug/bin/
          cp build-debug/nvdaControllerClient.dll dist/debug/bin/
          Compress-Archive -Path dist/* -DestinationPath prism-windows-arm64.zip
      - uses: actions/upload-artifact@v4
        with:
          name: windows-arm64
          path: prism-windows-arm64.zip

  macos:
    needs: version
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v5
      - name: Build Release
        run: |
          cmake -B build-arm64-release -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 -DPRISM_ENABLE_TESTS=OFF
          cmake --build build-arm64-release
          cmake -B build-x64-release -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 -DPRISM_ENABLE_TESTS=OFF
          cmake --build build-x64-release
      - name: Build Debug
        run: |
          cmake -B build-arm64-debug -DCMAKE_BUILD_TYPE=Debug -DPRISM_ENABLE_TESTS=OFF -DCMAKE_OSX_ARCHITECTURES=arm64
          cmake --build build-arm64-debug
          cmake -B build-x64-debug -DCMAKE_BUILD_TYPE=Debug -DPRISM_ENABLE_TESTS=OFF -DCMAKE_OSX_ARCHITECTURES=x86_64
          cmake --build build-x64-debug
      - name: Package
        run: |
          mkdir -p dist/release/lib dist/debug/lib dist/include
          lipo -create build-arm64-release/libprism.dylib build-x64-release/libprism.dylib -output dist/release/lib/libprism.dylib
          lipo -create build-arm64-debug/libprism.dylib build-x64-debug/libprism.dylib -output dist/debug/lib/libprism.dylib
          cp -r build-arm64-debug/libprism.dylib.dSYM dist/debug/lib/ 2>/dev/null || true
          cp include/prism.h dist/include/
          zip -r prism-macos-universal.zip dist
      - uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: prism-macos-universal.zip
  ios:
    needs: version
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v5
      - name: Build Release
        run: |
          cmake -B build-release -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=14.0 -DPRISM_ENABLE_TESTS=OFF
          cmake --build build-release
      - name: Build Debug
        run: |
          cmake -B build-debug -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=14.0 -DPRISM_ENABLE_TESTS=OFF
          cmake --build build-debug
      - name: Package
        run: |
          mkdir -p dist/release/lib dist/debug/lib dist/include
          cp build-release/libprism.a dist/release/lib/ 2>/dev/null || cp build-release/libprism.dylib dist/release/lib/
          cp build-debug/libprism.a dist/debug/lib/ 2>/dev/null || cp build-debug/libprism.dylib dist/debug/lib/
          cp -r build-debug/*.dSYM dist/debug/lib/ 2>/dev/null || true
          cp include/prism.h dist/include/
          zip -r prism-ios-arm64.zip dist
      - uses: actions/upload-artifact@v4
        with:
          name: ios-arm64
          path: prism-ios-arm64.zip

  linux-x64:
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y libspeechd-dev libglib2.0-dev
      - name: Build Release
        run: |
          cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DPRISM_ENABLE_TESTS=OFF
          cmake --build build-release
      - name: Build Debug
        run: |
          cmake -B build-debug -DCMAKE_BUILD_TYPE=Debug -DPRISM_ENABLE_TESTS=OFF
          cmake --build build-debug
      - name: Package
        run: |
          mkdir -p dist/release/lib dist/debug/lib dist/include
          cp build-release/libprism.so dist/release/lib/
          cp build-debug/libprism.so dist/debug/lib/
          cp include/prism.h dist/include/
          zip -r prism-linux-x64.zip dist
      - uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: prism-linux-x64.zip
  linux-arm64:
    needs: version
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v5
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y libspeechd-dev libglib2.0-dev
      - name: Build Release
        run: |
          cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DPRISM_ENABLE_TESTS=OFF
          cmake --build build-release
      - name: Build Debug
        run: |
          cmake -B build-debug -DCMAKE_BUILD_TYPE=Debug -DPRISM_ENABLE_TESTS=OFF
          cmake --build build-debug
      - name: Package
        run: |
          mkdir -p dist/release/lib dist/debug/lib dist/include
          cp build-release/libprism.so dist/release/lib/
          cp build-debug/libprism.so dist/debug/lib/
          cp include/prism.h dist/include/
          zip -r prism-linux-arm64.zip dist
      - uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: prism-linux-arm64.zip
  android:
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Build
        run: ./gradlew assembleRelease assembleDebug
      - name: Package
        run: |
          mkdir -p dist/{debug,release}
          mkdir -p dist/include
          cp build/android/gradle/outputs/aar/*-release.aar dist/release/
          cp build/android/gradle/outputs/aar/*-debug.aar dist/debug/
          cp include/prism.h dist/include/
          zip -r prism-android.zip dist
      - uses: actions/upload-artifact@v4
        with:
          name: android
          path: prism-android.zip

  emscripten:
      needs: version
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v5
        - uses: mymindstorm/setup-emsdk@v14
          with:
            version: latest
        - name: Build Release
          run: |
            emcmake cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DPRISM_ENABLE_TESTS=OFF
            cmake --build build-release
        - name: Build Debug
          run: |
            emcmake cmake -B build-debug -DCMAKE_BUILD_TYPE=Debug -DPRISM_ENABLE_TESTS=OFF
            cmake --build build-debug
        - name: Package
          run: |
            mkdir -p dist/release dist/debug dist/include
            cp build-release/libprism.a dist/release/
            cp build-debug/libprism.a dist/debug/
            cp include/prism.h dist/include/
            zip -r prism-wasm.zip dist    
        - uses: actions/upload-artifact@v4
          with:
            name: wasm
            path: prism-wasm.zip

  release:
    needs: [version, docs, windows-x64, windows-arm64, macos, ios, linux-x64, linux-arm64, android, emscripten]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Assemble SDK
        run: |
          tag="${{ needs.version.outputs.tag }}"
          sdk="prism-sdk-${tag}"
          mkdir -p "${sdk}"/{windows/x64,windows/arm64,macos/universal,ios/arm64,linux/x64,linux/arm64,android,wasm,include,doc}
          cp include/prism.h "${sdk}/include/"
          cp -r artifacts/docs/* "${sdk}/doc/"
          unzip -q artifacts/windows-x64/prism-windows-x64.zip -d "${sdk}/windows/x64/"
          unzip -q artifacts/windows-arm64/prism-windows-arm64.zip -d "${sdk}/windows/arm64/"
          unzip -q artifacts/macos-universal/prism-macos-universal.zip -d "${sdk}/macos/universal/"
          unzip -q artifacts/ios-arm64/prism-ios-arm64.zip -d "${sdk}/ios/arm64/"
          unzip -q artifacts/linux-x64/prism-linux-x64.zip -d "${sdk}/linux/x64/"
          unzip -q artifacts/linux-arm64/prism-linux-arm64.zip -d "${sdk}/linux/arm64/"
          unzip -q artifacts/android/prism-android.zip -d "${sdk}/android/"
          unzip -q artifacts/wasm/prism-wasm.zip -d "${sdk}/wasm/"
          find "${sdk}" -type d -name include -not -path "${sdk}/include" -exec rm -rf {} +
          zip -r "${sdk}.zip" "${sdk}"
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: PRISM ${{ needs.version.outputs.tag }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            prism-sdk-${{ needs.version.outputs.tag }}.zip
            artifacts/windows-x64/prism-windows-x64.zip
            artifacts/windows-arm64/prism-windows-arm64.zip
            artifacts/macos-universal/prism-macos-universal.zip
            artifacts/ios-arm64/prism-ios-arm64.zip
            artifacts/linux-x64/prism-linux-x64.zip
            artifacts/linux-arm64/prism-linux-arm64.zip
            artifacts/android/prism-android.zip
            artifacts/wasm/prism-wasm.zip